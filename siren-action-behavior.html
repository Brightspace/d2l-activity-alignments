<script>
	'use strict';
	window.D2L = window.D2L || {};
	window.D2L.PolymerBehaviors = window.D2L.PolymerBehaviors || {};
	window.D2L.PolymerBehaviors.Outcomes = window.D2L.PolymerBehaviors.Outcomes || {};
	/*
	* Behavior for processing siren actions
	* @polymerBehavior
	*/
	D2L.PolymerBehaviors.Outcomes.SirenActionBehaviorImpl = {
		getSirenFields: function(action) {
			var url = new URL(action.href, window.location.origin);
			var fields;
			if (action.method === 'GET' || action.method === 'HEAD') {
				fields = url.searchParams;
			} else if (window.URLSearchParams && action.type === 'application/x-www-form-urlencoded') {
				fields = new URLSearchParams();
			} else {
				fields = new FormData();
			}
			if (action.fields && action.fields.forEach) {
				action.fields.forEach(function(field) {
					if (field.value === undefined) {
						return;
					}
					// if the field is specified multiple times, assume it is intentional
					fields.append(field.name, field.value);
				});
			}
			return fields;
		},
		getEntityUrl: function(action, fields) {
			if (!action) {
				return null;
			}
			var url = new URL(action.href, window.location.origin);
			fields = fields || this.getSirenFields(action);
			if (action.method === 'GET' || action.method === 'HEAD') {
				url = new URL(url.pathname + '?' + fields.toString(), url.origin);
			}
			return url;
		},
		_appendHiddenFields: function(action, fields) {
			if (action.fields && action.fields.forEach) {
				action.fields.forEach(function(field) {
					if (field.type === 'hidden' && field.value !== undefined) {
						fields.append(field.name, field.value);
					}
				});
			}
			return fields;
		},
		performSirenAction: function(action, fields) {
			if (!action) {
				return Promise.reject(new Error('No action given'));
			}
			var headers = new Headers();
			this.token && headers.append('Authorization', 'Bearer ' + this.token);
			var url = this.getEntityUrl(action, fields);
			var body;
			if (fields) {
				fields = this._appendHiddenFields(action, fields);
			} else {
				fields = this.getSirenFields(action);
			}
			if (action.method !== 'GET' && action.method !== 'HEAD') {
				body = fields;
			}
			if (body && action.type.indexOf('json') !== -1) {
				var json = {};
				body.keys().forEach(function(key) {
					json[key] = action.getFieldByName(key).value;
				});
				headers.set('Content-Type', action.type);
				body = JSON.stringify(json);
			}
			var request = new Request(url, {
				method: action.method,
				body: body,
				headers: headers
			});
			return this._makeRequest(request)
				.then(function(body) {
					var entity = window.D2L.Hypermedia.Siren.Parse(body);
					return entity;
				});
		}
	};
	/** @polymerBehavior */
	D2L.PolymerBehaviors.Outcomes.SirenActionBehavior = [
		D2L.PolymerBehaviors.FetchSirenEntityBehavior,
		D2L.PolymerBehaviors.Outcomes.SirenActionBehaviorImpl
	];
</script>
